<section class="mypage-shell mypage-history-detail-shell">
  <%- include('./partials/mypage_sidebar', { currentMenu, consultationHistory, relatives }) %>
  <%
    const req = record && record.request ? record.request : {};
    const isCompatibility = String(req.featureKey || '').toLowerCase() === 'compatibility';
    const featureLabel = req.featureLabel || req.counselingType || '-';
    const targetName = isCompatibility
      ? `${String(req.person1Name || '').trim() || '사람1'} × ${String(req.person2Name || '').trim() || '사람2'}`
      : (req.name || '-');

    function toGenderLabel(v) {
      const x = String(v || '').trim().toLowerCase();
      if (x === 'male' || x === 'm') return '남성';
      if (x === 'female' || x === 'f') return '여성';
      return v || '-';
    }
    function toRelationLabel(v) {
      const x = String(v || '').trim().toUpperCase();
      const map = {
        SPOUSE: '배우자',
        PARENT: '부모',
        GRANDPARENT: '조부모',
        SON: '아들',
        DAUGHTER: '딸',
        SIBLING: '형제자매',
        FAMILY: '가족',
        FRIEND: '친구',
        OTHER: '기타',
      };
      return map[x] || v || '-';
    }
  %>

  <div class="mypage-content">
    <article class="mypage-card">
      <h3>상담 상세</h3>
      <p class="mypage-desc">결과 ID: <strong><%= record.resultId %></strong></p>

      <div class="mypage-history-meta-grid">
        <p><strong>상태</strong> <span><%= record.statusText %></span></p>
        <p><strong>요청일시</strong> <span><%= record.createdAt || '-' %></span></p>
        <p><strong>상담유형</strong> <span><%= featureLabel %></span></p>
        <p><strong>대상명</strong> <span><%= targetName %></span></p>
      </div>

      <div class="mypage-share-box">
        <p class="mypage-desc">이 상담 결과만 외부에 공유할 수 있습니다.</p>
        <button type="button" class="mypage-btn primary" id="shareCopyBtn">공유하기</button>
        <div class="mypage-share-link-wrap" id="shareLinkWrap" <%= record.share && record.share.enabled && record.share.token ? '' : 'style="display:none"' %>>
          <input
            id="shareLinkInput"
            class="mypage-share-link-input"
            type="text"
            readonly
            value="<%= record.share && record.share.enabled && record.share.token ? ('/saju/shared/' + record.share.token) : '' %>"
          >
        </div>
      </div>
    </article>

    <article class="mypage-card">
      <h3>요청 정보</h3>
      <% if (isCompatibility) { %>
        <div class="mypage-history-meta-grid">
          <p><strong>관계</strong><span><%= toRelationLabel(req.relationship) %></span></p>
          <p><strong>사람1</strong><span><%= req.person1Name || '-' %></span></p>
          <p><strong>사람1 생년월일</strong><span><%= [req.person1BirthYear, req.person1BirthMonth, req.person1BirthDay].filter(Boolean).join('-') || '-' %></span></p>
          <p><strong>사람1 출생시</strong><span><%= req.person1BirthTime || '-' %></span></p>
          <p><strong>사람1 성별</strong><span><%= toGenderLabel(req.person1Gender) %></span></p>
          <p><strong>사람2</strong><span><%= req.person2Name || '-' %></span></p>
          <p><strong>사람2 생년월일</strong><span><%= [req.person2BirthYear, req.person2BirthMonth, req.person2BirthDay].filter(Boolean).join('-') || '-' %></span></p>
          <p><strong>사람2 출생시</strong><span><%= req.person2BirthTime || '-' %></span></p>
          <p><strong>사람2 성별</strong><span><%= toGenderLabel(req.person2Gender) %></span></p>
        </div>
      <% } else { %>
        <div class="mypage-history-meta-grid">
          <p><strong>생년</strong><span><%= req.birthYear || '-' %></span></p>
          <p><strong>생월</strong><span><%= req.birthMonth || '-' %></span></p>
          <p><strong>생일</strong><span><%= req.birthDay || '-' %></span></p>
          <p><strong>출생시</strong><span><%= req.birthTime || '-' %></span></p>
          <p><strong>성별</strong><span><%= toGenderLabel(req.gender) %></span></p>
          <p><strong>상담대상</strong><span><%= req.targetType || '-' %></span></p>
        </div>
      <% } %>
    </article>

    <article class="mypage-card">
      <h3>상담 결과</h3>
      <div class="mypage-history-result">
        <% if (record.result && record.result.claudeResult) { %>
          <pre class="mypage-code"><%= record.result.claudeResult %></pre>
        <% } else { %>
          <p class="mypage-empty">아직 결과가 없습니다.</p>
        <% } %>
      </div>
    </article>
  </div>
</section>

<script>
(function () {
  const shareCopyBtn = document.getElementById('shareCopyBtn');
  const wrap = document.getElementById('shareLinkWrap');
  const input = document.getElementById('shareLinkInput');
  if (!shareCopyBtn || !wrap || !input) return;

  function toAbsolute(url) {
    if (!url) return '';
    if (url.startsWith('http://') || url.startsWith('https://')) return url;
    return window.location.origin + url;
  }

  async function writeClipboard(text) {
    try {
      await navigator.clipboard.writeText(text);
      return true;
    } catch (err) {
      input.select();
      try {
        document.execCommand('copy');
        return true;
      } catch (copyErr) {
        return false;
      }
    }
  }

  async function shareWithDevice(url) {
    if (!navigator.share) return { supported: false, shared: false };
    try {
      await navigator.share({
        title: '상담 결과 공유',
        text: '상담 결과를 공유합니다.',
        url
      });
      return { supported: true, shared: true };
    } catch (err) {
      if (err && err.name === 'AbortError') {
        return { supported: true, shared: false, canceled: true };
      }
      return { supported: true, shared: false };
    }
  }

  shareCopyBtn.addEventListener('click', async () => {
    shareCopyBtn.disabled = true;
    const original = shareCopyBtn.textContent;
    shareCopyBtn.textContent = '준비 중...';

    try {
      let shareUrl = input.value ? toAbsolute(input.value) : '';

      if (!shareUrl) {
        const res = await fetch('/api/saju/request/<%= record.resultId %>/share', {
          method: 'POST',
          credentials: 'same-origin'
        });
        const json = await res.json();
        if (!res.ok || json.resp !== 'OK') {
          alert(json.resp_message || '공유 링크 생성에 실패했습니다.');
          return;
        }

        shareUrl = toAbsolute(json.share_url || '');
        input.value = shareUrl;
        wrap.style.display = 'flex';
      }

      const shared = await shareWithDevice(shareUrl);
      if (shared.supported && shared.shared) return;

      const copied = await writeClipboard(shareUrl);
      if (copied) {
        alert(shared.canceled ? '공유를 취소하여 링크를 복사했습니다.' : '공유 링크를 복사했습니다.');
      } else {
        alert('공유/복사에 실패했습니다. 링크를 수동으로 복사해주세요.');
      }
    } catch (err) {
      alert('공유 링크 처리 중 오류가 발생했습니다.');
    } finally {
      shareCopyBtn.disabled = false;
      shareCopyBtn.textContent = original;
    }
  });

  if (input.value) {
    input.value = toAbsolute(input.value);
  }
})();
</script>
